# Migration Deployment Guide

## Overview

This guide helps you apply the pending database migrations to your Supabase project.

## Pending Migrations

1. **20251010T021104Z_reservation_constraints.sql** - Adds necessary columns, constraints, and indexes to `reservations` table
2. **20251015T000000Z_create_reservation_transaction_function.sql** - Creates atomic transaction function for reservations

## Current Database State

Based on verification (run `node scripts/verify-constraints.mjs`):

### Missing Columns in `reservations` Table
- ❌ `external_payment_id` (TEXT) - External payment ID from Stripe/PayPal
- ❌ `webhook_event_id` (BIGINT) - Reference to webhook event
- ❌ `expires_at` (TIMESTAMPTZ) - Reservation expiration time
- ❌ `amount` (DECIMAL) - Total reservation amount
- ❌ `updated_at` (TIMESTAMPTZ) - Last update timestamp

### Missing Function
- ❌ `create_reservation_transaction()` - Atomic reservation creation

## Deployment Options

### Option 1: Supabase Dashboard (Recommended)

1. **Open Supabase Dashboard**
   - Go to [https://app.supabase.com](https://app.supabase.com)
   - Select your project

2. **Navigate to SQL Editor**
   - Click on "SQL Editor" in the left sidebar
   - Click "New query"

3. **Execute Migration**
   - Copy the contents of `combined_migration.sql` (generated by running `node scripts/apply-migration.mjs`)
   - Paste into the SQL Editor
   - Click "Run" or press `Cmd+Enter` (Mac) / `Ctrl+Enter` (Windows)

4. **Verify Success**
   - Run `node scripts/verify-constraints.mjs`
   - All checks should show ✅

### Option 2: Using psql (Advanced)

```bash
# If you have direct database access
psql "postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres" -f combined_migration.sql
```

### Option 3: Supabase CLI (If configured)

```bash
# Apply migrations via Supabase CLI
supabase db push
```

## Verification

After applying migrations, verify everything is set up correctly:

```bash
# Run verification script
node scripts/verify-constraints.mjs
```

Expected output:
```
✅ All required columns exist!
✅ Function exists and validation works
```

## Migration Details

### Constraints Added

1. **unique_external_payment_per_provider** - Ensures payment IDs are unique per provider
2. **valid_reservation_amount** - Ensures amount is non-negative
3. **valid_reservation_status** - Ensures status is one of: pending, paid, cancelled, expired, refunded
4. **idx_one_active_reservation_per_puppy** - Ensures only one active reservation per puppy

### Indexes Added

- `idx_reservations_puppy_id` - Fast lookups by puppy
- `idx_reservations_status` - Fast filtering by status
- `idx_reservations_payment_provider` - Fast filtering by payment provider
- `idx_reservations_external_payment_id` - Fast lookups by payment ID
- `idx_reservations_webhook_event_id` - Fast joins with webhook events
- `idx_reservations_expires_at` - Fast expiration queries
- `idx_reservations_created_at` - Fast chronological queries

### Functions Added

1. **create_reservation_transaction()** - Atomic reservation creation with race condition protection
2. **check_puppy_availability()** - Trigger function to validate puppy availability
3. **expire_pending_reservations()** - Utility to expire old pending reservations
4. **get_reservation_summary()** - Analytics function for reservation stats

### Triggers Added

- **enforce_puppy_availability** - Prevents double-booking

## Rollback (If Needed)

If you need to rollback the migration:

```sql
-- Drop added constraints
ALTER TABLE reservations DROP CONSTRAINT IF EXISTS unique_external_payment_per_provider;
ALTER TABLE reservations DROP CONSTRAINT IF EXISTS valid_reservation_amount;
ALTER TABLE reservations DROP CONSTRAINT IF EXISTS valid_reservation_status;

-- Drop indexes
DROP INDEX IF EXISTS idx_one_active_reservation_per_puppy;
DROP INDEX IF EXISTS idx_reservations_payment_provider;
DROP INDEX IF EXISTS idx_reservations_external_payment_id;
DROP INDEX IF EXISTS idx_reservations_webhook_event_id;
DROP INDEX IF EXISTS idx_reservations_expires_at;

-- Drop functions
DROP FUNCTION IF EXISTS create_reservation_transaction;
DROP FUNCTION IF EXISTS check_puppy_availability;
DROP FUNCTION IF EXISTS expire_pending_reservations;
DROP FUNCTION IF EXISTS get_reservation_summary;

-- Drop trigger
DROP TRIGGER IF EXISTS enforce_puppy_availability ON reservations;

-- Drop columns (WARNING: This will lose data!)
ALTER TABLE reservations DROP COLUMN IF EXISTS external_payment_id;
ALTER TABLE reservations DROP COLUMN IF EXISTS webhook_event_id;
ALTER TABLE reservations DROP COLUMN IF EXISTS expires_at;
ALTER TABLE reservations DROP COLUMN IF EXISTS amount;
ALTER TABLE reservations DROP COLUMN IF EXISTS updated_at;
```

## Troubleshooting

### Error: "constraint already exists"
This is safe to ignore - it means part of the migration was already applied.

### Error: "column already exists"
This is safe to ignore - the migration checks for existing columns.

### Error: "relation does not exist"
Ensure you're running the migration on the correct database and that the `reservations` table exists.

### Error: Permission denied
Ensure you're using the service role key or database owner credentials.

## Post-Migration Tasks

After successful migration:

1. ✅ Verify all constraints are in place
2. ✅ Test the `create_reservation_transaction` function
3. ✅ Deploy updated application code that uses the new schema
4. ✅ Monitor logs for any errors

## Questions?

If you encounter any issues:
1. Check the verification script output: `node scripts/verify-constraints.mjs`
2. Review Supabase logs in the Dashboard
3. Consult the migration files for details on what should be created
