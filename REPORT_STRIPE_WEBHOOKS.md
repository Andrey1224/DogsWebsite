# –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Stripe Webhooks –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Stripe Webhooks, –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏ –ª–æ–≥–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

---

## A) Stripe Webhook Handler

–û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤ Stripe –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `app/api/stripe/webhook/route.ts`. –≠—Ç–æ—Ç —Ñ–∞–π–ª –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∏ –∏ –ø–µ—Ä–µ–¥–∞—á—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.

### –§–∞–π–ª: `app/api/stripe/webhook/route.ts`

```typescript
// app/api/stripe/webhook/route.ts

export async function POST(req: NextRequest) {
  try {
    // 1. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ (—á–∏—Ç–∞–µ—Ç—Å—è raw body)
    const rawBody = await req.text();
    const signature = req.headers.get('stripe-signature');

    // ... –ø—Ä–æ–≤–µ—Ä–∫–∏ signature ...

    let event: Stripe.Event;
    try {
      event = stripe.webhooks.constructEvent(rawBody, signature, webhookSecret);
    } catch (err) {
      // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–ø–∏—Å–∏ ...
    }

    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ StripeWebhookHandler
    const result = await StripeWebhookHandler.processEvent(event);

    // 3. –û—Ç–≤–µ—Ç Stripe (200 OK –¥–∞–∂–µ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å retry)
    if (result.success || result.duplicate) {
      return NextResponse.json({ ... }, { status: 200 });
    }

    // ...
  }
}
```

–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π (switch/case) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `lib/stripe/webhook-handler.ts`.

### –§–∞–π–ª: `lib/stripe/webhook-handler.ts`

–ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑–±–æ—Ä —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `payment_intent`.

```typescript
// lib/stripe/webhook-handler.ts

static async processEvent(event: Stripe.Event): Promise<WebhookProcessingResult> {
    // ...
    switch (type) {
      case 'checkout.session.completed':
        return this.handleCheckoutSessionCompleted(event, eventId);
      // ... –¥—Ä—É–≥–∏–µ –∫–µ–π—Å—ã ...
    }
}

private static async handleCheckoutSessionCompleted(event, eventId) {
    const session = event.data.object as TypedCheckoutSession;

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ Payment Intent
    const paymentIntentId = getPaymentIntentId(session);

    // –õ–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª B)
    // ...

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
    if (session.payment_status !== 'paid') {
        // –û–∂–∏–¥–∞–Ω–∏–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        return { error: 'Payment pending - waiting for async_payment_succeeded' };
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    return this.createReservationFromSession(...);
}
```

---

## B) –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è / Idempotency

–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–∞–±–ª–∏—Ü–∞ `webhook_events`) –∏ –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`IdempotencyManager`).

### –¢–∞–±–ª–∏—Ü–∞ `webhook_events` (–ú–∏–≥—Ä–∞—Ü–∏—è)

–§–∞–π–ª: `supabase/migrations/20251010021049_webhook_events.sql`

```sql
CREATE TABLE IF NOT EXISTS webhook_events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  provider TEXT NOT NULL CHECK (provider IN ('stripe', 'paypal')),
  event_id TEXT NOT NULL,
  event_type TEXT NOT NULL,
  processed BOOLEAN NOT NULL DEFAULT FALSE,
  idempotency_key TEXT,
  -- ...
);

-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ provider + event_id
ALTER TABLE webhook_events ADD CONSTRAINT unique_webhook_event
  UNIQUE (provider, event_id);

-- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –∫–ª—é—á—É –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
CREATE UNIQUE INDEX IF NOT EXISTS unique_idempotency_key
  ON webhook_events(idempotency_key)
  WHERE idempotency_key IS NOT NULL;
```

### –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ (`lib/reservations/idempotency.ts`)

```typescript
// lib/reservations/idempotency.ts

async checkWebhookEvent(provider, eventId, idempotencyKey?) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ provider + event_id
    const { data: existingEvent } = await this.supabase
        .from('webhook_events')
        .eq('provider', provider)
        .eq('event_id', eventId)
        .single();

    if (existingEvent) return { exists: true, ... };

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ idempotency_key
    if (idempotencyKey) {
        // ... –ø—Ä–æ–≤–µ—Ä–∫–∞ idempotency_key ...
    }

    // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ç–∞–∫–∏–º payment_id
    // (–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ webhook_event –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è, –Ω–æ –±—Ä–æ–Ω—å –µ—Å—Ç—å)
    const { data: reservation } = await this.supabase
        .from('reservations')
        .eq('provider', provider)
        .eq('external_payment_id', eventId)
        .single();

    if (reservation) return { exists: true, ... };

    return { exists: false };
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Webhook Handler

```typescript
// lib/stripe/webhook-handler.ts

const paymentDedupeKey = `stripe:${paymentIntentId}`;
const idempotencyCheck = await idempotencyManager.checkWebhookEvent(
  'stripe',
  paymentDedupeKey,
  paymentDedupeKey,
);

if (idempotencyCheck.exists) {
  console.log(`Duplicate event detected for payment_intent ${paymentIntentId}`);
  return { duplicate: true, ... };
}
```

---

## C) –õ–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ reservations

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ 'paid'

–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ `lib/stripe/webhook-handler.ts` –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

```typescript
// lib/stripe/webhook-handler.ts (–º–µ—Ç–æ–¥ createReservationFromSession)

// 1. –°–æ–∑–¥–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ —Å—Ç–∞—Ç—É—Å 'pending' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ ReservationCreationService)
const { reservationId } = await ReservationCreationService.createReservation({ ... });

// 2. –Ø–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ 'paid'
try {
  const updatedReservation = await ReservationQueries.updateStatus(reservationId, 'paid');
  if (!updatedReservation) {
     console.error(`Failed to update reservation ${reservationId} to paid status`);
  }
} catch (statusUpdateError) {
  // –í–ê–ñ–ù–û: –û—à–∏–±–∫–∞ –∑–¥–µ—Å—å –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (Non-fatal)
  console.error(`Error updating reservation status:`, statusUpdateError);
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î (`lib/reservations/queries.ts`)

```typescript
// lib/reservations/queries.ts

static async updateStatus(id: string, status: ReservationStatus) {
    return this.update(id, { status });
}
```

### –õ–æ–≥–∏–∫–∞ –æ—Ç–º–µ–Ω—ã –∏ Expired

–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ RPC —Ñ—É–Ω–∫—Ü–∏—é `expire_pending_reservations` (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –≤–µ—Ä–æ—è—Ç–Ω–æ, –ø–æ –∫—Ä–æ–Ω—É –∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä—É, –æ–±–µ—Ä—Ç–∫–∞ –µ—Å—Ç—å –≤ `lib/reservations/queries.ts`).

```typescript
// lib/reservations/queries.ts
static async expireOldPending(): Promise<number> {
    const { data } = await supabase.rpc('expire_pending_reservations');
    return data || 0;
}
```

---

## D) –ü–æ—á–µ–º—É –ø–∏—Å—å–º–∞ —É—à–ª–∏, —Ö–æ—Ç—è paid –Ω–µ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω

–û—Ç–≤–µ—Ç –∫—Ä–æ–µ—Ç—Å—è –≤ –±–ª–æ–∫–µ `try/catch` –≤–Ω—É—Ç—Ä–∏ `lib/stripe/webhook-handler.ts`.

### –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º (`lib/stripe/webhook-handler.ts`)

```typescript
// ... –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ...

// –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ 'paid'
try {
  await ReservationQueries.updateStatus(reservationId, 'paid');
} catch (statusUpdateError) {
  // –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –ü–†–û–î–û–õ–ñ–ê–ï–¢–°–Ø
  console.error(`Error updating reservation status:`, statusUpdateError);
}

// ... –¥–∞–ª–µ–µ –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è ...

// –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ó–î–ï–°–¨, –¥–∞–∂–µ –µ—Å–ª–∏ updateStatus –≤—ã—à–µ —É–ø–∞–ª
const emailData = { ... };

void Promise.all([
  sendOwnerDepositNotification(emailData),
  sendCustomerDepositConfirmation(emailData),
]).catch((error) => {
  console.error('Failed to send email notifications:', error);
});
```

**–ü—Ä–∏—á–∏–Ω–∞:**

1. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è (—É—Å–ø–µ—à–Ω–æ).
2. –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ `paid` –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –æ—à–∏–±–∫–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π –ë–î, —Ç–∞–π–º–∞—É—Ç RLS –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏), –Ω–æ —ç—Ç–∞ –æ—à–∏–±–∫–∞ **–ø–æ–¥–∞–≤–ª—è–µ—Ç—Å—è** (catch –±–µ–∑ rethrow).
3. –ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–∏—Å–µ–º.
4. –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ.
5. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –ø–∏—Å—å–º–æ, –Ω–æ –≤ –±–∞–∑–µ —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–ª—Å—è `pending` (–∏–ª–∏ –∏—Å—Ö–æ–¥–Ω—ã–º), —Ç–∞–∫ –∫–∞–∫ `updateStatus` –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª.

### –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º (`lib/emails/deposit-notifications.ts`)

–§—É–Ω–∫—Ü–∏–∏ `sendOwnerDepositNotification` –∏ `sendCustomerDepositConfirmation` –∏—Å–ø–æ–ª—å–∑—É—é—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `Resend`.

```typescript
// lib/emails/deposit-notifications.ts

export async function sendCustomerDepositConfirmation(data: DepositData) {
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∏ ...
  await getResendClient().emails.send({
    to: [data.customerEmail],
    subject: `üéâ Deposit Confirmed ...`,
    html: generateCustomerDepositEmail(data),
  });
}
```

---

## E) –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–∞–≥–∞ Early Return (10.01.2026)

### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–í —Ñ—É–Ω–∫—Ü–∏–∏ `createReservationFromSession` (`lib/stripe/webhook-handler.ts:486`) –±—ã–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

```typescript
private static async createReservationFromSession(...) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
  const existingReservation = await ReservationServerQueries.getByPayment('stripe', paymentIntentId);

  if (existingReservation?.id) {
    console.log(`Payment intent ${paymentIntentId} already has reservation ${existingReservation.id}, skipping`);
    return {
      success: true,
      duplicate: true,
      skipped: true,
      reservationId: existingReservation.id,
      error: 'Reservation already exists for payment intent',
    };
  }

  // –î–∞–ª—å—à–µ —Å–æ–∑–¥–∞–Ω–∏–µ webhook_event, markProcessing, –∏ —Ç.–¥.
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**

1. –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è (–¥–∞–∂–µ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`), —Ñ—É–Ω–∫—Ü–∏—è **—Å—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è** (early return)
2. `createWebhookEvent` –∏ `markProcessing` **–ù–ï –≤—ã–∑—ã–≤–∞—é—Ç—Å—è**
3. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
   - `webhook_events.processed = false`
   - `webhook_events.processing_started_at = null`
   - –†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ `pending`
   - –ß–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (`pg_cron`)
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç success page –∏ –ø–æ–ª—É—á–∞–µ—Ç email, –Ω–æ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è

### –†–µ—à–µ–Ω–∏–µ

**1. –ò–∑–º–µ–Ω—ë–Ω —Ç–∏–ø –≤–æ–∑–≤—Ä–∞—Ç–∞ `WebhookEventsServer.markProcessing()`**

–§–∞–π–ª: `lib/webhooks/webhook-events-server.ts:55`

```typescript
// –ë–´–õ–û: Promise<boolean>
// –°–¢–ê–õ–û: Promise<void>

static async markProcessing(params: MarkProcessingParams): Promise<void> {
  // ... –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ...

  if (data && data.length > 0) {
    console.log(`Marked event as processing: ${params.provider}:${params.eventId}`);
    return;
  }

  // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
  throw new Error(
    `No webhook event found to mark as processing: ${params.provider}:${params.eventId}`
  );
}
```

**2. –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ webhook event –≤ –Ω–∞—á–∞–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏**

–§–∞–π–ª: `lib/stripe/webhook-handler.ts:486-590`

```typescript
private static async createReservationFromSession(...) {
  // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook event –ü–ï–†–ï–î –ª—é–±—ã–º–∏ early returns
  await idempotencyManager.createWebhookEvent({
    provider: 'stripe',
    eventId,
    eventType,
    idempotencyKey: `stripe:${paymentIntentId}`,
    payload: { ... },
  });

  // –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∫–∞–∫ processing (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É)
  try {
    await WebhookEventsServer.markProcessing({
      provider: 'stripe',
      eventId,
      idempotencyKey: `stripe:${paymentIntentId}`,
      eventType,
    });
  } catch (markError) {
    console.error('[Stripe Webhook] CRITICAL: Failed to mark webhook event as processing:', markError);
    return {
      success: false,
      eventType,
      paymentIntentId,
      error: 'Failed to mark webhook event as processing',
    };
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
  const existingReservation = await ReservationServerQueries.getByPayment('stripe', paymentIntentId);

  if (existingReservation?.id) {
    console.log(`Payment intent ${paymentIntentId} already has reservation ${existingReservation.id}`);

    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ï—Å–ª–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –≤ —Å—Ç–∞—Ç—É—Å–µ 'paid', –ø–µ—Ä–µ–≤–æ–¥–∏–º –µ—ë –≤ 'paid'
    if (existingReservation.status !== 'paid') {
      console.log(`Reservation ${existingReservation.id} is in status '${existingReservation.status}', marking as paid`);

      try {
        await ReservationServerQueries.markPaid({
          reservationId: existingReservation.id,
          provider: 'stripe',
          externalPaymentId: paymentIntentId,
        });
        console.log(`Reservation ${existingReservation.id} marked as paid`);
      } catch (markPaidError) {
        console.error(`Failed to mark existing reservation as paid:`, markPaidError);
        // –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–º–µ—Ç–∏—Ç—å webhook –∫–∞–∫ processed
      }
    }

    // –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ webhook event –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ
    try {
      await WebhookEventsServer.markProcessed({
        provider: 'stripe',
        eventId,
        idempotencyKey: `stripe:${paymentIntentId}`,
      });
      console.log(`Webhook event ${eventId} marked as processed`);
    } catch (markError) {
      console.error(`CRITICAL: Failed to mark webhook event as processed:`, markError);
    }

    return {
      success: true,
      eventType,
      paymentIntentId,
      duplicate: true,
      skipped: true,
      reservationId: existingReservation.id,
      error: 'Reservation already exists for payment intent',
    };
  }

  // ... –¥–∞–ª–µ–µ –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ ...
}
```

**3. –£–¥–∞–ª—ë–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥**

–£–¥–∞–ª–µ–Ω—ã —Å—Ç—Ä–æ–∫–∏ 718-739, –≥–¥–µ `createWebhookEvent` –∏ `markProcessing` –≤—ã–∑—ã–≤–∞–ª–∏—Å—å –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ (—Ç–µ–ø–µ—Ä—å –æ–Ω–∏ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏).

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–§–∞–π–ª: `lib/stripe/webhook-handler.test.ts:246`

–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Ç–µ—Å—Ç:

```typescript
it('should mark existing pending reservation as paid', async () => {
  // Mock —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π pending —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
  (ReservationServerQueries.getByPayment as any).mockResolvedValueOnce({
    id: 'existing-res-123',
    status: 'pending',
    puppy_id: mockPuppyId,
    customer_email: 'test@example.com',
    external_payment_id: mockPaymentIntentId,
    payment_provider: 'stripe',
  });

  const result = await StripeWebhookHandler.processEvent(event);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ:
  expect(result.success).toBe(true);
  expect(result.duplicate).toBe(true);
  expect(result.reservationId).toBe('existing-res-123');

  // 1. Webhook event –±—ã–ª —Å–æ–∑–¥–∞–Ω
  expect(idempotencyManager.createWebhookEvent).toHaveBeenCalled();

  // 2. Webhook event –±—ã–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ processing
  expect(WebhookEventsServer.markProcessing).toHaveBeenCalled();

  // 3. –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è –±—ã–ª–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ paid
  expect(ReservationServerQueries.markPaid).toHaveBeenCalledWith({
    reservationId: 'existing-res-123',
    provider: 'stripe',
    externalPaymentId: mockPaymentIntentId,
  });

  // 4. Webhook event –±—ã–ª –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ processed
  expect(WebhookEventsServer.markProcessed).toHaveBeenCalled();
});
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ:**

```bash
‚úì Tests: 604 passed (54 files)
‚úì TypeScript: no errors
‚úì ESLint: no warnings
```

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **lib/webhooks/webhook-events-server.ts** (—Å—Ç—Ä–æ–∫–∏ 55-126)
   - `markProcessing()` —Ç–µ–ø–µ—Ä—å –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –≤–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ `false`

2. **lib/stripe/webhook-handler.ts** (—Å—Ç—Ä–æ–∫–∏ 486-590)
   - Webhook event —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö pending —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
   - –£–¥–∞–ª—ë–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –∫–æ–¥

3. **lib/stripe/webhook-handler.test.ts** (—Å—Ç—Ä–æ–∫–∏ 29-32, 246-334)
   - –û–±–Ω–æ–≤–ª—ë–Ω –º–æ–∫ –¥–ª—è `markProcessing`
   - –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç –¥–ª—è pending —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π

### –ì–∞—Ä–∞–Ω—Ç–∏–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

‚úÖ Webhook event –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `processing` –≤ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `pending` —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è –≤ `paid`
‚úÖ Webhook event –≤—Å–µ–≥–¥–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `processed` –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
‚úÖ –†–µ–∑–µ—Ä–≤–∞—Ü–∏–∏ –ù–ï –±—É–¥—É—Ç –æ—Ç–º–µ–Ω—è—Ç—å—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤ Stripe
‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è "success page + email, –Ω–æ —Å—Ç–∞—Ç—É—Å = cancelled"
