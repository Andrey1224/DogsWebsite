# üöÄ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

## ‚ùå –ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫

**–ü—Ä–æ–±–ª–µ–º–∞:** –¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
- `webhook_events` ‚Üí —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `reservations`
- `reservations` ‚Üí —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ `webhook_events`

–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É –¥–æ –¥—Ä—É–≥–æ–π! üîÑ

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã **–ë–ï–ó** –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π, –∞ –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è–µ–º FK –æ—Ç–¥–µ–ª—å–Ω—ã–º —à–∞–≥–æ–º.

## üìã –ß—Ç–æ –¥–µ–ª–∞—Ç—å (3 –º–∏–Ω—É—Ç—ã)

### –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å Supabase
1. –ó–∞–π—Ç–∏ –Ω–∞ https://app.supabase.com
2. –í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç
3. –û—Ç–∫—Ä—ã—Ç—å **SQL Editor** (–±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é)

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å SQL
–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª **`complete_migration_fixed.sql`** –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å **–í–°–Å** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.

### –®–∞–≥ 3: –í—Å—Ç–∞–≤–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
1. –í—Å—Ç–∞–≤–∏—Ç—å –≤ SQL Editor
2. –ù–∞–∂–∞—Ç—å **RUN** (–∏–ª–∏ `Cmd+Enter`)
3. –ü–æ–¥–æ–∂–¥–∞—Ç—å 3-5 —Å–µ–∫—É–Ω–¥

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:
```bash
node scripts/verify-constraints.mjs
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
‚úÖ All required columns exist!
‚úÖ Function exists and validation works
```

## üìä –ß—Ç–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è

### –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞: `webhook_events`
–î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö webhook —Å–æ–±—ã—Ç–∏–π –æ—Ç Stripe –∏ PayPal.

–ö–æ–ª–æ–Ω–∫–∏:
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
- `provider` - stripe –∏–ª–∏ paypal
- `event_id` - ID —Å–æ–±—ã—Ç–∏—è –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- `event_type` - —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
- `processed` - –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ª–∏
- `reservation_id` - —Å–≤—è–∑—å —Å —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–µ–π
- `payload` - –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ webhook
- –∏ –¥—Ä—É–≥–∏–µ...

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã: `reservations`
–î–æ–±–∞–≤–ª—è—é—Ç—Å—è 6 –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫:
- `payment_provider` - stripe/paypal
- `external_payment_id` - ID –ø–ª–∞—Ç–µ–∂–∞
- `webhook_event_id` - —Å–≤—è–∑—å —Å webhook —Å–æ–±—ã—Ç–∏–µ–º
- `expires_at` - –∫–æ–≥–¥–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è
- `amount` - —Å—É–º–º–∞ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
- `updated_at` - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `create_reservation_transaction()` - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–∏
- `check_puppy_availability()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —â–µ–Ω–∫–∞
- `expire_pending_reservations()` - –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏–π
- `get_reservation_summary()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ–∑–µ—Ä–≤–∞—Ü–∏—è–º

## üéØ –ü–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è (–≤–∞–∂–Ω–æ!)

```
1. –°–æ–∑–¥–∞—Ç—å webhook_events (–±–µ–∑ FK)
2. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ –≤ reservations (–±–µ–∑ FK)
3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
4. ‚≠ê –î–æ–±–∞–≤–∏—Ç—å FK (—Ç–µ–ø–µ—Ä—å –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç!)
5. –î–æ–±–∞–≤–∏—Ç—å constraints
6. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
7. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã
8. –í—ã–¥–∞—Ç—å –ø—Ä–∞–≤–∞
9. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
```

## ‚ö†Ô∏è –ï—Å–ª–∏ –ø–æ–ª—É—á–∏—à—å –æ—à–∏–±–∫—É

### "table already exists"
‚úÖ –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –ú–∏–≥—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `IF NOT EXISTS` - –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç.

### "constraint already exists"
‚úÖ –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º.

### "column already exists"
‚úÖ –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º.

### –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
1. –°–∫–æ–ø–∏—Ä—É–π **–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏**
2. –ü–æ—Å–º–æ—Ç—Ä–∏ –≤ –∫–∞–∫–æ–º STEP –æ—à–∏–±–∫–∞ (–≤ —Ç–µ–∫—Å—Ç–µ –±—É–¥–µ—Ç "STEP X:")
3. –ù–∞–ø–∏—à–∏ –º–Ω–µ - —Ä–∞–∑–±–µ—Ä—ë–º—Å—è!

## ‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
node scripts/verify-constraints.mjs

# 2. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∫–æ–¥
git add .
git commit -m "feat: apply complete migration with webhook_events"
git push origin main

# 3. –ì–æ—Ç–æ–≤–æ! üéâ
```

## üß™ –¢–µ—Å—Ç

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook_events
SELECT * FROM webhook_events LIMIT 1;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ reservations
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'reservations'
ORDER BY ordinal_position;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é
SELECT proname FROM pg_proc
WHERE proname = 'create_reservation_transaction';
```

---

## üìù –ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

1. –û—Ç–∫—Ä–æ–π Supabase Dashboard ‚Üí SQL Editor
2. –°–∫–æ–ø–∏—Ä—É–π **–≤–µ—Å—å** —Ñ–∞–π–ª `complete_migration_fixed.sql`
3. –í—Å—Ç–∞–≤—å –∏ –Ω–∞–∂–º–∏ RUN
4. –ü—Ä–æ–≤–µ—Ä—å: `node scripts/verify-constraints.mjs`
5. –ó–∞–¥–µ–ø–ª–æ–π: `git push origin main`

**–ì–æ—Ç–æ–≤–æ!** üöÄ
