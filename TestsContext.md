Контекст проекта

Стек: Next.js (App Router) + TypeScript + React + Supabase.

Тесты: Vitest (unit + component + интеграционные).

Текущие глобальные метрики покрытия (после удаления new-ui/):

Statements: ~44.6%

Lines: ~44.6%

Functions: ~71.4%

Branches: ~71.3%

Пороговые значения Vitest (глобально):

Lines/Statements ≥ 40%

Functions ≥ 70%

Бизнес-логику (lib/payments, lib/emails) уже покрыли хорошо: 80–100%.

Вывод:
Базовая защита есть, пороги выполняются. Дальше задача — точечно усиливать покрытие вокруг пользовательских флоу и критичных страниц, а не добивать проценты абстрактно.

2. Цели для LLM

Усилить покрытие тестами ключевых пользовательских сценариев, особенно на уровне страниц и компонентов.

Поддерживать или слегка повышать текущие глобальные пороги, не трогая их в меньшую сторону:

Lines/Statements: держать не ниже 40%, лучше ближе к 50–60%.

Functions: держать не ниже 70%, лучше выше.

Не дублировать уже хорошо покрытую бизнес-логику: не писать бессмысленные микротесты для lib/payments и lib/emails, если там уже 80–100%.

Делать тесты:

детерминированными;

без реальных сетевых/БД запросов;

ориентированными на поведение, а не на внутренние детали реализации.

3. Приоритеты по зонам проекта

Важно: сначала определи структуру репозитория (через ls, tree и т.п.), потом привяжи описания ниже к реальным путям.

3.1. Высокий приоритет — писать или усиливать тесты

Публичные страницы Next.js (app/)

Главная и маркетинговые страницы (например: /, /about, /questions, /science).

Страницы с данными щенков (листинги, карточки).

Формы: контакт/инквайри/бронь (например: /contact, /puppies/[slug] и аналогичные).

Задача:

Написать component/integration-тесты, которые:

рендерят страницу;

проверяют наличие ключевых блоков и данных;

проверяют базовые пользовательские сценарии (заполнение форм, клики по CTA, переходы по ссылкам).

Admin-панель (app/admin, components/admin, lib/admin и т.п.)

Сценарии:

просмотр списка щенков;

создание/редактирование/обновление статуса щенка;

другие критичные операции (архивация, soft delete и т.п., если есть).

Тесты:

компонентные/интеграционные тесты админ-страниц;

проверка:

рендера таблиц/списков;

валидации форм;

вызова соответствующих API/сервисных функций (через моки).

API-роуты (app/api/\*\*)

Приоритетные ручки:

получение списка щенков;

получение одного щенка;

операции резервирования/обновления статуса;

любые ручки, связанные с деньгами/депозитами (когда будут).

Тесты:

вызывать handler’ы напрямую (через импорт из route.ts);

использовать замоканный Supabase / сервисный слой;

проверять:

корректные статусы (200/201/4xx/5xx);

структуру и типы ответа;

поведение на валидных и невалидных payload’ах.

Ключевые общие компоненты (components/\*\*)

Card-компоненты (для щенков и т.п.);

компонентов форм (input-группы, кнопки, селекты, переключатели фильтров);

любые компоненты, которые используются в нескольких местах.

Тесты:

рендер с разными наборами пропсов;

работа основных событий (onClick, onChange, onSubmit);

отображение разных состояний (loading, error, empty state).

3.2. Средний приоритет

Интеграционные тесты для критичных флоу

Например:

“Пользователь заходит на страницу щенков → открывает карточку → отправляет инквайри/контакт форму”.

“Админ заходит в админку → изменяет статус щенка → изменения видны на публичной странице”.

Такие тесты могут быть:

либо на уровне Vitest + React Testing Library (с имитацией роутинга),

либо (если есть Playwright) — в виде E2E, но это уже отдельный слой.

4. Что игнорировать / не пытаться покрывать

Если в репозитории есть следующие зоны:

scripts/\*\* — одноразовые скрипты (например, optimize-images.mjs, check-puppies.mjs).

supabase/migrations/\*\* — SQL миграции.

Любые явно помеченные legacy/obsolete папки (например, legacy/**, old-ui/**, docs/prototypes/\*\* и т.п.).

Инструкция для LLM:

Не писать тесты для этих директорий.

Проверить vitest.config.\*:

Убедиться, что такие директории либо уже находятся в coverage.exclude, либо добавить их туда без снижения существующих порогов.

Если есть сомнение, пытается ли что-то из этого реально участвовать в рантайме — сначала проверить отсутствие импортов.

Пример настройки (адаптировать под реальный конфиг):

coverage: {
provider: 'v8',
thresholds: {
global: {
lines: 40,
functions: 70,
statements: 40,
},
},
exclude: [
'node_modules/**',
'tests/**',
'scripts/**',
'supabase/migrations/**',
'docs/prototypes/**',
'legacy/**',
'old-ui/**',
],
},

5. Стиль тестов и best practices

Использовать Vitest + React Testing Library для компонентов/страниц.

Тестировать поведение, а не внутреннюю реализацию:

что видит пользователь,

какие события происходят при кликах/инпуте,

какие запросы/коллбеки вызываются.

Mock внешних зависимостей:

Supabase, fetch, внешние API — всегда мокать;

если есть обёртки вроде lib/api/\*, мокать их, а не низкоуровневые детали.

Тесты должны быть:

детерминированными (фиксаная дата, если нужно),

быстрыми (без реальной сети/БД),

читаемыми (осмысленные названия тестов и describe-блоков).

6. Рабочий процесс для LLM

Проанализировать структуру проекта и текущий coverage-отчёт:

найти файлы и директории с 0–20% покрытия среди тех, которые:

не входят в coverage.exclude,

не являются скриптами/миграциями/legacy.

Составить краткий план тестирования:

список приоритетных файлов/модулей с указанием, какой тип теста нужен (unit/component/integration),

порядок, в котором логично добавлять тесты.

Итерировать:

добавить тесты для 1–2 приоритетных модулей,

запустить npm run test -- --coverage,

убедиться, что:

пороги не падают,

общие метрики либо стабильны, либо слегка растут,

повторить для следующих модулей.

Не менять глобальные thresholds вниз.

допустимо оставить их как есть или поднять в будущем, но не занижать.

7. Критерии успеха

Изменения считаются успешными, если:

Все тесты проходят, включая запуск с coverage.

Глобальные пороги:

Lines/Statements ≥ 40%,

Functions ≥ 70%,
остаются выполненными (желательно с запасом).

Ключевые зоны:

публичные страницы,

admin-панель,

критичные API-роуты,

общие компоненты,
действительно имеют видимые, осмысленные тесты.

scripts/\*\*, миграции и legacy-прототипы не утягивают coverage и не обрастают бессмысленными тестами.1111
